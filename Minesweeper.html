<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Minesweeper</title>
</head>
<body>
<script>
/* Tile */
var TILE = 20;
var DIM = 20;
	
/* Tile Types */
var EMPTY = 0, BOMB = -1;

/**
 * Game objects
 */
canvas,	  /* HTMLCanvas */
ctx,	  /* CanvasRenderingContext2d */
frames,   /* number, used for animation */
/**
 * Grid datastructor, usefull in games where the game world is
 * confined in absolute sized chunks of data or information.
 * 
 * @type {Object}
 */
grid = {
    ratio: null,  /* number, the number of columns */
    dim: null, /* number, the number of rows */
	_grid: null,  /* Array<any>, data representation */
  
	/**
	 * Initiate and fill a grid with the 
	 * @param  {float}    ratio   The percentage of mine tiles
	 * @param  {number}   dim     number of rows/columns
	 */
	init: function(ratio, dim) {
		this.ratio = ratio;
		this.dim = dim;
		this._grid = [];
		for (var x=0; x < dim; x++) {
			this._grid.push([]);
			for (var y=0; y < dim; y++) {
				this._grid[x].push(EMPTY);
			}
		}
        
        // Sets all the bombs
        for (var i=0; i < (dim^2)*ratio; i++) {
            var x = Math.random()%dim, y = Math.random()%dim;
            while (this.get(x,y) == BOMB) {
                x = Math.random()%dim; 
                y = Math.random()%dim;
            }
            this.set(BOMB, x, y);
        }
        
        // Sets all the bomb counts
        for (var x=0; x < dim; x++) {
			for (var y=0; y < dim; y++) {
				if (this.get(x,y) != BOMB) {
					this.setBombCount(x,y);
				}
			}
		}
	},
    
	/**
	* Sets the number of bombs surrounding a single tile
	*
	* @param {number} x    the x-coordinate
	* @param {number} y    the y-coordinate
	*/
	setBombCount: function(x, y) {
		this.set(this.getBombCount(x,y),x,y);
	},

	/**
	* Gets the number of bombs surrounding a single tile
	*
	* @param {number} x    the x-coordinate
	* @param {number} y    the y-coordinate
	*/
	getBombCount: function(x, y) {
		var count = 0;
		for (var i = -1; i < 2; i++) {
			for (var j = -1; i < 2; j++) {
			if ((i != 1 && j != 1) && this.get(i,j) == BOMB) {
				count++;
			}
			}
		}
		return count;
	},
  
	/**
	 * Set the value of the grid cell at (x, y)
	 * 
	 * @param {any}    val what to set
	 * @param {number} x   the x-coordinate
	 * @param {number} y   the y-coordinate
	 */
	set: function(val, x, y) {
		this._grid[x][y] = val;
	},
  
	/**
	 * Get the value of the cell at (x, y)t
	 * 
	 * @param  {number} x the x-coordinate
	 * @param  {number} y the y-coordinate
	 * @return {any}   the value at the cell
	 */
	get: function(x, y) {
        if (x >= 0 && x < this.dim && y >= 0 && y < this.dim) {
		    return this._grid[x][y];
        } else {
            return 0;
        }
	}
}

/**
 * Starts the game
 */
function main() {
	// create and initiate the canvas element
	canvas = document.createElement("canvas");
	
	canvas.width = dim*TILE;
	canvas.height = dim*TILE;
	ctx = canvas.getContext("2d");
	// add the canvas element to the body of the document
	document.body.appendChild(canvas);
	// sets an base font for bigger score display
	ctx.font = "12px Helvetica";
	frames = 0;
	
	// intatiate game objects and starts the game loop
	init();
	loop();
}
/**
 * Resets and inits game objects
 */
function init() {
	score = 0;
	var ratio = 0.2;
	grid.init(ratio, DIM);
}
/**
 * The game loop function, used for game updates and rendering
 */
function loop() {
	update();
	draw();
	// When ready to redraw the canvas call the loop function
	// first. Runs about 60 frames a second
	window.requestAnimationFrame(loop, canvas);
}
	
/**
 * Updates the game logic
 */
function update() {
	frames++;
}

/**
 * Render the grid to the canvas.
 */
function draw() {
	// iterate through the grid and draw all cells
	for (var x=0; x < grid.width; x++) {
		for (var y=0; y < grid.height; y++) {
			// sets the fillstyle depending on the id of
			// each cell
			switch (grid.get(x, y)) {
				case BOMB:
					ctx.fillStyle = "#f00";
					ctx.fillRect(x*DIM, y*DIM, DIM, DIM);
					break;
				case EMPTY:
					ctx.fillStyle = "#000";
					ctx.fillRect(x*DIM, y*DIM, DIM, DIM);
					break;
				default:
					ctx.fillStyle = "#fff";
					ctx.fillRect(x*DIM, y*DIM, DIM, DIM);
					ctx.fillStyle = "#000";
					ctx.fillText(grid.get(x,y));
					break;
			}
			
		}
	}
}
	
// start and run the game
main();
</script>
</body>
</html>
